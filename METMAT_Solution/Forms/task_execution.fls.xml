<form id='task_execution' menuName='Execute task' title='{"Task list"}' platforms="web"
    xmlns="http://schemas.mobilengine.com/fls/v2">
    <declarations>
        <let id='open_form' shape='scalar' value='{sysp.dtlFormOpen}'/>
        <let id='user_proj' shape='scalar' value='{
        loadNewerFromServer:SELECT us.active_project 
        FROM userState us INNER JOIN tester t ON us.tester_name = t.tester_name
        WHERE t.tester_email = sysp.user}'/>
    </declarations>
    <header>
    <submitbutton text="Save" nextForm="{forms.task_execution}"></submitbutton>
    </header>
    <chapter title="Select platform">
        <segmentedbutton id='platformID'
            choices='{SELECT DISTINCT tsk.platformID from task tsk left join environment env ON tsk.env_name = env.env_name WHERE
            tsk.project = user_proj AND CASE
    	WHEN ch_all_user.checked THEN true
    	ELSE env.tester_email = sysp.user END }'
            keyMap="{platformID}"
            textMap="{platformID}">
        </segmentedbutton>
    </chapter>
    <chapter title='Select tested version (default is latest)'>
        <dropdown id='dd_versionGlobal'
            choices='{select tv.version from versions tv where tv.project = user_proj order by version desc}'
            keyMap='{version}'
            textMap='{version}'
            selectedKey='{select tv.version from versions tv where tv.current = 1 AND tv.project = user_proj}'>
        </dropdown>
    </chapter>
    <chapter title='Filter by status'>
        <dropdown id="ddstatus" keyMap='{v}' textMap='{v}' choices='{["not yet started", "success", "failed", "not tested", "bad test case","resolved"]}' selectedKey='{"not yet started"}'/>
    </chapter>
    <chapter title='Filter by user(s)'>
        <checkbox id='ch_all_user' text='all user' />
    </chapter>
    <chapter title="Selected test cases">
    <declarations>
        <let id="selected" shape="scalar" value="{0}"/>
    </declarations>
        <if cond="{selected = 1}">
            <table id="selectedTasks" record="task" recordset='{SELECT "" guid, "" TestId, "" description,"" result, "" version, "" envName, 0 time, "" note,  "" link WHERE false}'>
                <header>
                    <row>
                        <cell>
                            <textview text=""/>
                        </cell>
                        <cell>
                            <textview text="Test case id"/>
                        </cell>
                        <cell>
                            <textview text="Description"/>
                        </cell>
                        <cell>
                            <textview text="To test case"/>
                        </cell>
                        <cell>
                            <textview text="Result"/>
                        </cell>
                        <cell>
                            <textview text="Version"/>
                        </cell>
                        <cell>
                            <textview text="Enviromnent"/>
                        </cell>
                        <cell>
                            <textview text="Time needed"/>
                        </cell>
                        <cell>
                            <textview text="Note"/>
                        </cell>
                        <cell>
                            <textview text=""/>
                        </cell>
                    </row>
                </header>
                <row>
                <declarations>
                    <let id="guid" shape="scalar" value="{task.guid}" />
                </declarations>
                    <cell>
                    <combinedbutton text="Cancel">
                        <actionbutton>
                            <set value="{0}" target="selected"/>
                        </actionbutton>
                        <removebutton/>
                    </combinedbutton>

                    </cell>
                    <cell>
                        <textview id="id" text="{task.TestId}"/>
                    </cell>
                    <cell>
                        <textview id="description" text="{task.description}"/>
                    </cell>
                    <cell>
                        <if cond='{(SELECT Count(tc.TestId) FROM manualTests tc WHERE tc.TestId = task.TestId) > 0}'>
						    <discardbutton text='Go to manual test' id="totestWrite" nextForm='{forms.manualTestWriter}'> 
                            <params>
                                <param id='test_Id' value='{task.TestId}'/>
                                <param id='edit' value='{"2"}'/>
                                <param id='fromForm' value='{"task_executionNew"}'/>
                            </params>
                            </discardbutton>
					    </if>
					    <if cond='{(SELECT Count(tc.TestId) FROM manualTests tc WHERE tc.TestId = task.TestId) = 0}'>
                            <linkview url="{task.link}" text="Go to test"/>
                            <textbox id="linkText" text="{task.link}"> 
                            <declarations><let id="fChanged" shape="scalar" value="{text IS NOT task.link}"/></declarations>
                        </textbox>
                        </if>
                    </cell>
                    <cell>
                        <dropdown id="result" selectedKey="{task.result}" keyMap='{v}' textMap='{v}' choices='{["not yet started", "success", "failed", "not tested", "bad test case", "resolved"]}'>
                        <declarations><let id="fChanged" shape="scalar" value="{selectedKey IS NOT task.result}"/></declarations>
                        </dropdown>
                    </cell>
                    <cell>
                        <textview id="testedVer" text="{task.version}"/>
                    </cell>
                    <cell>
                        <textview id="envName" text="{task.envName}"/>
                    </cell>
                    <cell>
                        <numberbox id="runTime" number="{task.time}"> 
                            <validation>
                                <validator cond='{runTime.number is not NULL}' message="Required"></validator>
                            </validation>
                        </numberbox>
                    </cell>
                    <cell>
                        <textbox id="note" text="{task.note}"> 
                            <declarations><let id="fChanged" shape="scalar" value="{text IS NOT task.note}"/></declarations>
                            <validation>
                                <validator cond='{(note.text is not NULL ) OR (result.selectedKey IS NOT "bad test case")}' message="Required"></validator>
                            </validation>
                            
                        </textbox>
                    </cell>
                </row>
            </table>
        </if>
        <if cond="{selected = 0}">
            <table id="assignedTasks" record="task"
            recordset='{SELECT tsk.guid, 
                            tsk.task_id, 
                            tsk.env_name, 
                            tsk.task_type, 
                            tsk.note, 
                            tsk.time_need,
                            tsk.result,
                            tsk.version,
                            tc.link,
                            tc.tc_description
		                from task tsk INNER JOIN test_case tc  ON tc.id = tsk.task_id
                        WHERE   (tsk.result = ddstatus.selectedKey AND
                                tsk.project = user_proj AND
                                tsk.platformID = platformID.selectedKey AND
                                tsk.env_name IN (SELECT env.env_name FROM environment env WHERE CASE WHEN ch_all_user.checked THEN true ELSE env.tester_email = sysp.user END)) ORDER BY task_id
                                
                        }'>
                <header>
                    <row>
                         <cell>
                            <textview text=""/>
                        </cell>
                        <cell>
                            <textview text="Test case id"/>
                        </cell>
                        <cell>
                            <textview text="Description"/>
                        </cell>
                        <cell>
                            <textview text="To test case"/>
                        </cell>
                        <cell>
                            <textview text="Result"/>
                        </cell>
                        <cell>
                            <textview text="Version"/>
                        </cell>
                        <cell>
                            <textview text="Enviromnent"/>
                        </cell>
                        <cell>
                            <textview text="Time needed"/>
                        </cell>
                        <cell>
                            <textview text="Note"/>
                        </cell>
                        <cell>
                            <textview text=""/>
                        </cell>
                    </row>
                </header>
                <row>
                    <cell>

                            <combinedbutton text="Select">
                                <addbutton records='{SELECT task.guid guid, 
                                                            task.task_id TestId, 
                                                            task.tc_description description, 
                                                            task.result , 
                                                            dd_versionGlobal.selectedKey version, 
                                                            task.env_name envName, 
                                                            toint(task.time_need) time,
                                                            task.note,
                                                            task.link
                                                    }' table="selectedTasks" />
                                <actionbutton>
                                    <set value="{1}" target="selected" />
                                </actionbutton>
                            </combinedbutton>

                    </cell>
                    <cell>
                        <textview text="{task.task_id}"/>
                    </cell>
                    <cell>
                        <textview text="{task.tc_description}"/>
                    </cell>
                    <cell>
                        <if cond='{(SELECT Count(tc.TestId) FROM manualTests tc WHERE tc.TestId = task.task_id) > 0}'>
						    <discardbutton text='Go to manual test' id="totestWrite" nextForm='{forms.manualTestWriter}'> 
                            <params>
                                <param id='test_Id' value='{task.task_id}'/>
                                <param id='edit' value='{"2"}'/>
                                <param id='fromForm' value='{"task_executionNew"}'/>
                            </params>
                            </discardbutton>
					    </if>
					    <if cond='{(SELECT Count(tc.TestId) FROM manualTests tc WHERE tc.TestId = task.task_id) = 0}'>
                    	    <linkview id='tcLink' url="task.link" text=" Go to test"/>
                	    </if>
                    </cell>
                    <cell>
                        <textview text="{task.result}"/>
                    </cell>
                    <cell>
                        <textview text="{task.version}"/>
                    </cell>
                    <cell>
                        <textview text="{task.env_name}"/>
                    </cell>
                    <cell>
                        <textview text="{task.time_need}"/>
                    </cell>
                    <cell>
                        <textview text="{task.note}"/>
                    </cell>
                </row>
            </table>
        </if>
    </chapter> 
</form>