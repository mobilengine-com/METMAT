<form id='dashboard' menuName='Dashboard' title="Dashboard"
												platforms="web" xmlns="http://schemas.mobilengine.com/fls/v2"
												dashboard='true'>
	<declarations>
		
		<let id="testersCount" shape="scalar" value='{SELECT COUNT(ts.tester_email) FROM tester ts WHERE ts.tester_role = "Tester"}' />
		<let id='today' shape='scalar' value='{sysp.dtlFormOpen}' />
		
		<let id="left_from_today_hour" shape='scalar' value='{SELECT case when toint(gethour(today)) >= 9 THEN (case when toint(gethour(today)) >= 17 THEN 0 ELSE 17-(toint(gethour(today))+1) END) ELSE 8 END}' />
		<let id="left_from_today_minut" shape="scalar" value='{SELECT case WHEN toint(gethour(today)) >= 9 THEN (case when toint(gethour(today)) >= 17 THEN 0 ELSE 60-toint(getminute(today)) END)ELSE 0 END}' />
		<let id="remains_from_today_hour" shape="scalar" value='{tofloat(left_from_today_hour)+tofloat(left_from_today_minut)/60}' />

		<let id='jira_done' shape='scalar' value='{tester_by_result.closed_sum_j.text}'/>		
		<let id='jira_sum' shape='scalar' value='{tester_by_result.all_jira_ver_sum.text}'/>		
		<let id='task_env_table' access="private" shape='table' value='{
			select tsk.task_id, tsk.result, tsk.env_name, tsk.task_type, tsk.end_tc_date, e.tester_name, tcl.tc_prio, tcl.tc_impreg
				from task tsk
				left join environment e on tsk.env_name = e.env_name
				left join tc_list tcl on tsk.task_id = tcl.tc_id
		}'/>

		<let id='user_proj' shape='scalar' value='{loadNewerFromServer:SELECT t.selected_project FROM tester t WHERE t.tester_email = sysp.user}' />
		<let id='currentVersion' shape='scalar' value='{SELECT v.version FROM versions v WHERE v.current = 1 AND v.project = user_proj}' />
	</declarations>

<header>
	
</header>
	<hbox style="{styles.projectDisplay}">
		<textview style="{styles.projectDisplay}" text='{"Current selected project is: "||user_proj}'/>
		<popup id="changeppop" title="" openMode='dialog' deferred='true' linkIcon='{icons.settings}'>
			<backbutton text="X"/>
			<table id="projectTable" record="ver" recordset="{loadNewerFromServer:SELECT  v.project FROM versions v GROUP BY v.project}">
				<header><row>
					<cell>
						<textview text='Project name'/>
					</cell>
					<cell>
						<textview text='Selected'/>
					</cell>
				</row></header>
				<row>
					<cell>
						<textview id="project" text='{ver.project}'/>
					</cell>
					<cell>
						<if cond='{ver.project = user_proj}'>
							<textview labelIcon="{icons.qa_accept_x}"/>
						</if>
						<if cond='{not (ver.project = user_proj)}'>
							<combinedbutton id="changeProjectSubmit" text="Select">
							<submitbutton closeForm="{false}" />
							<backbutton />
						</combinedbutton>
						</if>
					</cell>
				</row>
			</table>
		</popup>
	</hbox>
	<chapter title='Test run finish date'>
	<declarations>
		<let id="result" shape="table" value='{loadNewerFromServer:SELECT cr.plannedFinish, cr.doneCount, cr.totalCount, cr.participate, cr.leftCount, cr.requiredHours, cr.requiredDays, cr.finishDate 
		FROM calculatedResults cr 
		WHERE cr.Type = "Run" AND cr.version = currentVersion AND cr.project = user_proj}' />
	</declarations>
		<textview text='{"All selected test count: " || (SELECT tostring(r.totalCount) FROM result r)}'/>
		<textview text='{"Tester count who is testing: " || (SELECT tostring(r.participate) FROM result r)}'/>
		<textview text='{"Planned finish date: " || (SELECT toString(FORMATDTL(r.plannedFinish,(dtf yyyy "-" MM "-" dd))) FROM result r)}'/>
		<textview text='{"Remaining test count: " || (SELECT tostring(r.leftCount) FROM result r)}'/>
		<textview text='{"Required working hours: " || (SELECT tostring(r.requiredHours) FROM result r)}'/>
		<textview text='{"Required working days: " || (SELECT tostring(r.requiredDays) FROM result r)}'/>
		<textview text='{"Actual finish date: " || (SELECT tostring(FORMATDTL(r.finishDate,(dtf yyyy "-" MM "-" dd))) FROM result r)}'/>
		<textview text='{"Progress: %"|| (SELECT tostring(toint((tofloat(r.doneCount)/tofloat(r.totalCount))*100)) FROM result r)}'/>
		<submitbutton text="Recalculate" closeForm="{false}" id="recRun"/>
		<submitbutton text="Save current date as planned finish date" closeForm="{false}" id="savePlannedRun"/>
	</chapter>

	<chapter title="Testcase write finish date">
		
	<declarations>
		<let id="resultW" shape="table" value='{loadNewerFromServer:SELECT cr.plannedFinish, cr.doneCount, cr.totalCount, cr.participate, cr.leftCount, cr.requiredHours, cr.requiredDays, cr.finishDate, cr.finishDateExtended 
		FROM calculatedResults cr 
		WHERE  cr.Type = "Write" AND cr.version = currentVersion AND cr.project = user_proj}' />
	</declarations>

		<textview text='{"Tester count who is writeing tests: " || (SELECT tostring(cr.participate) FROM resultW cr)}'/>
		<textview text='{"Planned finish date: " || (SELECT toString(FORMATDTL(cr.plannedFinish,(dtf yyyy "-" MM "-" dd))) FROM resultW cr)}'/>
		<textview text='{"Remaining to write test count: "||(SELECT toString(cr.leftCount) FROM resultW cr)}'/>
		<textview text='{"Already created test count: "||(SELECT toString(cr.doneCount) FROM resultW cr)}'/>
		<textview text='{"Required working hours to write tests: " || (SELECT tostring(cr.requiredHours) FROM resultW cr)}'/>
		<textview text='{"Required rounded working days to write tests: " || (SELECT tostring(cr.requiredDays) FROM resultW cr)}'/>
		<textview text='{"Actual finish date with test writing: " || (SELECT tostring(FORMATDTL(cr.finishDate,(dtf yyyy "-" MM "-" dd))) FROM resultW cr)}'/>
		<textview text='{"Actual finish date with test writing and 2 week of late preparation: " || (SELECT tostring(FORMATDTL(cr.finishDateExtended,(dtf yyyy "-" MM "-" dd))) FROM resultW cr)}'/>
		<textview text='{"Progress: %"|| (SELECT tostring(toint((tofloat(cr.doneCount)/tofloat(cr.totalCount))*100)) FROM resultW cr)}'/>
		<submitbutton text="Recalculate" closeForm="{false}" id="recWrite"/>
		<submitbutton text="Save current date as planned finish date" closeForm="{false}" id="savePlannedWrite"/>
	</chapter>
	<chapter title='Jira tickets'>
		<popup title='Jira tickets' openMode="dialog">
			<backbutton linkIcon="{icons.delete}" text="{Null}" />
				<table id='task_list_table_j' record='task_list_table_j_r' recordset='{
											select tsk.task_id, tsk.env_name, tsk.task_type, e.tester_name, tsk.result, j.jira_id, j.jira_state
											from task tsk 
											left join tc_jira_list j on tsk.task_id = j.task_id
											left join environment e on tsk.env_name = e.env_name
											WHERE j.jira_id is not null and tsk.task_id LIKE "%" || UPPER( filter_taskid.text) || "%" }'>
					<header>
						<row>
							<cell>
								<textview text='Task ID'/>
								<textbox id='filter_taskid'/>
							</cell>
							<cell>
								<textview text='Reporter'/>
							</cell>
							<cell>
								<textview text='Jira'/>
							</cell>
							<cell>
								<textview text='Edit state'/>
							</cell>
							<cell>
								<textview text='Link'/>
							</cell>
						</row>           
					</header>
					<row>		
						<cell>		
							<textview text='{task_list_table_j_r.task_id}'/>
						</cell>		
						<cell>		
							<textview text='{task_list_table_j_r.tester_name}'/>
						</cell>			
						<cell>
							<linkview url="{task_list_table_j_r.jira_id}" linkIcon='{icons.link}'/> 
						</cell>
						<cell>
							<dropdown id='add_tcs_status'
                        	keyMap="{v}"
                        	textMap="{v}"
                        	selectedKey="{task_list_table_j_r.jira_state}"
                        	choices='{["InProgress", "Done", "Reopen"]}'>
                    </dropdown>
						</cell>
						<cell>
							<popup title="{NULL}" openMode="dialog" linkIcon="{icons.eye}">
								<hbox>
									<backbutton/>
									<textview text='{task_list_table_j_r.jira_id}'/> 
								</hbox>
							</popup>
						</cell>
					</row>
				</table>
		</popup>
	</chapter>
	<chapter title='Jira ticket verification by testers'>
			<table id='tester_by_result' record='tester_by_result_r' recordset='{
					select distinct e.tester_name
					from environment e group by e.tester_name}'>
				<header>
					<row>
						<declarations>
						<let id='unassigned_j' shape='scalar' value='{select count(tet.result) from task_env_table tet 
							where tet.result="not yet started" and 
								tet.env_name is null and
								tet.task_type="j"}'/>
						</declarations>
						<cell>
							<textview text='Tester name'/>
						</cell>
						<cell>
							<textview text='Not yet started'/>
						</cell>
						<cell>
							<textview text='Closed'/>
						</cell>
					</row>
				</header>
				<row>
					<cell>
						<textview text='{tester_by_result_r.tester_name}'/>
					</cell>
					<cell>
						<textview id='not_yet_started_j' text='{select tostring(count(tet.result)) from task_env_table tet 
											where tet.result="not yet started" and 
												tet.tester_name=tester_by_result_r.tester_name and
												tet.task_type="j"}'/>
					</cell>
					<cell>
						<textview id='closed_j' text='{select tostring(count(tet.result)) from task_env_table tet 
											where tet.result="closed" and 
												tet.tester_name=tester_by_result_r.tester_name and
												tet.task_type="j"}'/>
					</cell>
				</row>
				<footer>
					<row>
						<cell>
							<textview text='{"unassigned: " || tostring(unassigned_j)}'/>
						</cell>
						<cell>
							<textview id="not_yet_started_sum_j" text='{select tostring(SUM(toint(tbr.not_yet_started_j.text))) from tester_by_result.rows tbr}'/>
						</cell>
						<cell>
							<textview id="closed_sum_j" text='{select tostring(SUM(toint(tbr.closed_j.text))) from tester_by_result.rows tbr}'/>
						</cell>
						<cell>
							<textview id='all_jira_ver_sum' text='{tostring(unassigned_j+toint(not_yet_started_sum_j.text)+toint(closed_sum_j.text))}'/>
						</cell>
					</row>
				</footer>
			</table>
	</chapter>
</form>